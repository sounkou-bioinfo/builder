name: Release binaries

on:
  push:
    branches: [master]
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}

    name: ${{ matrix.artifact }}-R${{ matrix.r }}

    strategy:
      fail-fast: false
      matrix:
        r: ['release', 'oldrel-1']
        include:
          - os: ubuntu-latest
            artifact: builder-linux-amd64
            ext: ''
            r: 'release'
          - os: ubuntu-latest
            artifact: builder-linux-amd64
            ext: ''
            r: 'oldrel-1'
          - os: ubuntu-24.04-arm
            artifact: builder-linux-arm64
            ext: ''
            r: 'release'
          - os: ubuntu-24.04-arm
            artifact: builder-linux-arm64
            ext: ''
            r: 'oldrel-1'
          - os: macos-latest
            artifact: builder-macos-arm64
            ext: ''
            r: 'release'
          - os: macos-latest
            artifact: builder-macos-arm64
            ext: ''
            r: 'oldrel-1'
          - os: windows-latest
            artifact: builder-windows-amd64
            ext: '.exe'
            r: 'release'
          - os: windows-latest
            artifact: builder-windows-amd64
            ext: '.exe'
            r: 'oldrel-1'

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r }}

      - name: Get R version for artifact name
        id: rver
        shell: bash
        run: |
          RVER=$(Rscript -e "cat(paste0(R.version\$major, '.', R.version\$minor))")
          echo "rver=${RVER}" >> "$GITHUB_OUTPUT"

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcre2-dev libzstd-dev liblzma-dev libbz2-dev zlib1g-dev libtirpc-dev

      - name: Build binary (Unix)
        if: runner.os != 'Windows'
        run: |
          CC=$(R CMD config CC)
          CFLAGS=$(R CMD config --cppflags)
          LDFLAGS=$(R CMD config --ldflags)
          EXTRA="-Wall -Wno-unused-result -Wno-nonportable-include-path -Iinclude -s -O2"
          $CC $EXTRA $CFLAGS src/*.c -o builder $LDFLAGS
          chmod 755 builder

      - name: Build binary (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          CC=$(R CMD config CC)
          CFLAGS=$(R CMD config --cppflags)
          LDFLAGS=$(R CMD config --ldflags)
          EXTRA="-Wall -Wno-unused-result -Wno-nonportable-include-path -Iinclude -s -O2"
          $CC $EXTRA $CFLAGS src/*.c -o builder.exe $LDFLAGS

      - name: Smoke test
        shell: bash
        run: |
          export LD_LIBRARY_PATH="$(R RHOME)/lib:${LD_LIBRARY_PATH:-}"
          export DYLD_LIBRARY_PATH="$(R RHOME)/lib:${DYLD_LIBRARY_PATH:-}"
          ./builder${{ matrix.ext }} -version

      - name: Package binary
        shell: bash
        run: |
          ARCHIVE="${{ matrix.artifact }}-R${{ steps.rver.outputs.rver }}"
          mkdir -p dist
          cp builder${{ matrix.ext }} dist/
          cp LICENSE dist/
          cd dist
          if [ "${{ runner.os }}" = "Windows" ]; then
            7z a ../${ARCHIVE}.zip *
          else
            tar czf ../${ARCHIVE}.tar.gz *
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}-R${{ steps.rver.outputs.rver }}
          path: ${{ matrix.artifact }}-R${{ steps.rver.outputs.rver }}.*

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from DESCRIPTION
        id: version
        run: |
          VER=$(awk -F': *' '/^Version:/ {print $2}' Rpkg/DESCRIPTION)
          echo "version=${VER}" >> "$GITHUB_OUTPUT"
          echo "Building release for v${VER}"

      - name: Collect archives
        run: |
          mkdir release
          find artifacts -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec cp {} release/ \;
          ls -lh release/

      - name: Upload to r-pkg-release-binaries
        uses: softprops/action-gh-release@v2
        with:
          tag_name: r-pkg-release-binaries
          name: "R package pre-built binaries (v${{ steps.version.outputs.version }})"
          body: |
            Pre-built `builder` binaries for use with the R package.
            Built against multiple R versions for ABI compatibility.

            Download the archive matching your platform and R version,
            or install the R package directly:
            ```r
            remotes::install_github("devOpifex/builder", subdir = "Rpkg")
            ```
          prerelease: true
          make_latest: false
          files: release/*

      - name: Upload to version tag
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: "v${{ steps.version.outputs.version }}"
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: release/*
