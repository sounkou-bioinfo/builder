name: Release binaries

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: builder-linux-amd64
            ext: ''
          - os: macos-latest
            artifact: builder-macos-arm64
            ext: ''
          - os: windows-latest
            artifact: builder-windows-amd64
            ext: '.exe'

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcre2-dev libzstd-dev liblzma-dev libbz2-dev zlib1g-dev libtirpc-dev

      - name: Build binary (Unix)
        if: runner.os != 'Windows'
        run: |
          CC=$(R CMD config CC)
          CFLAGS=$(R CMD config --cppflags)
          LDFLAGS=$(R CMD config --ldflags)
          EXTRA="-Wall -Wno-unused-result -Wno-nonportable-include-path -Iinclude -s -O2"
          $CC $EXTRA $CFLAGS src/*.c -o builder $LDFLAGS
          chmod 755 builder

      - name: Build binary (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          CC=$(R CMD config CC)
          CFLAGS=$(R CMD config --cppflags)
          LDFLAGS=$(R CMD config --ldflags)
          EXTRA="-Wall -Wno-unused-result -Wno-nonportable-include-path -Iinclude -s -O2"
          $CC $EXTRA $CFLAGS src/*.c -o builder.exe $LDFLAGS

      - name: Smoke test
        shell: bash
        run: ./builder${{ matrix.ext }} -version

      - name: Package binary
        shell: bash
        run: |
          mkdir -p dist
          cp builder${{ matrix.ext }} dist/
          cp LICENSE dist/
          cd dist
          if [ "${{ runner.os }}" = "Windows" ]; then
            7z a ../${{ matrix.artifact }}.zip *
          else
            tar czf ../${{ matrix.artifact }}.tar.gz *
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from DESCRIPTION
        id: version
        run: |
          VER=$(awk -F': *' '/^Version:/ {print $2}' Rpkg/DESCRIPTION)
          echo "version=${VER}" >> "$GITHUB_OUTPUT"
          echo "Building release for v${VER}"

      - name: Collect archives
        run: |
          mkdir release
          find artifacts -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec cp {} release/ \;
          ls -lh release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "v${{ steps.version.outputs.version }}"
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: release/*
