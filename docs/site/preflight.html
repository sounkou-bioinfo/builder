<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>preflight</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      /* The extra [class] is a hack that increases specificity enough to
         override a similar rule in reveal.js */
      ul.task-list[class]{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          background-color: #232629;
          color: #7a7c7d;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
      div.sourceCode
        { color: #cfcfc2; background-color: #232629; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { color: #cfcfc2; } /* Normal */
      code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
      code span.an { color: #3f8058; } /* Annotation */
      code span.at { color: #2980b9; } /* Attribute */
      code span.bn { color: #f67400; } /* BaseN */
      code span.bu { color: #7f8c8d; } /* BuiltIn */
      code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #3daee9; } /* Char */
      code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
      code span.co { color: #7a7c7d; } /* Comment */
      code span.cv { color: #7f8c8d; } /* CommentVar */
      code span.do { color: #a43340; } /* Documentation */
      code span.dt { color: #2980b9; } /* DataType */
      code span.dv { color: #f67400; } /* DecVal */
      code span.er { color: #da4453; text-decoration: underline; } /* Error */
      code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
      code span.fl { color: #f67400; } /* Float */
      code span.fu { color: #8e44ad; } /* Function */
      code span.im { color: #27ae60; } /* Import */
      code span.in { color: #c45b00; } /* Information */
      code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
      code span.op { color: #cfcfc2; } /* Operator */
      code span.ot { color: #27ae60; } /* Other */
      code span.pp { color: #27ae60; } /* Preprocessor */
      code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
      code span.sc { color: #3daee9; } /* SpecialChar */
      code span.ss { color: #da4453; } /* SpecialString */
      code span.st { color: #f44f4f; } /* String */
      code span.va { color: #27aeae; } /* Variable */
      code span.vs { color: #da4453; } /* VerbatimString */
      code span.wa { color: #da4453; } /* Warning */
    </style>
        <link rel="stylesheet" href="style.css" />
      </head>
  <body>
    <main>
      <nav>
        <a href="index.html">Home</a>
        <a href="packages.html">Packages</a>
        <a href="directives.html">Directives</a>
        <a href="macros.html">Macros</a>
        <a href="include.html">Include</a>
        <a href="import.html">Import</a>
        <a href="fstrings.html">F-strings</a>
        <a href="const.html">Const</a>
        <a href="deconstruct.html">Deconstruct</a>
        <a href="preflight.html">Preflight</a>
        <a href="plugins.html">Plugins</a>
        <a href="tests.html">Tests</a>
      </nav>
      <h1 id="preflight">Preflight</h1>
      <p>Preflight blocks allow you to run R code
      <strong>before</strong> the main preprocessing phase. This is
      useful for validation checks, environment verification, or
      early-exit conditions that should halt the build if requirements
      aren’t met.</p>
      <h2 id="how-it-works">How It Works</h2>
      <p>When Builder encounters a <code>#preflight</code> block during
      processing, it:</p>
      <ul>
      <li>Extracts all R code between <code>#preflight</code> and the
      end marker</li>
      <li>Immediately evaluates the R code</li>
      <li>If the code fails (throws an error), the build stops</li>
      <li>If successful, preprocessing continues normally</li>
      </ul>
      <p>The preflight code is executed as-is and is
      <strong>not</strong> subject to preprocessor directives or macro
      expansion.</p>
      <h2 id="syntax">Syntax</h2>
      <p>Preflight blocks are defined using <code>#preflight</code> and
      closed with either <code>#endpreflight</code> or the shorthand
      <code>#endflight</code>:</p>
      <div class="sourceCode" id="cb1"><pre
      class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#preflight</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Your R validation code here</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span>condition) <span class="fu">stop</span>(<span class="st">&quot;Requirement not met&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#endflight</span></span></code></pre></div>
      <h2 id="example-version-check">Example: Version Check</h2>
      <p>A common use case is verifying the R version meets minimum
      requirements:</p>
      <div class="sourceCode" id="cb2"><pre
      class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#preflight</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>rver <span class="ot">&lt;-</span> version<span class="sc">$</span>major <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(rver <span class="sc">&lt;</span> <span class="dv">4</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;We need R version 4.x.x at least&quot;</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#endflight</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Rest of your code continues here...</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="dv">1</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
      <p>If the R version is less than 4, the build will halt
      immediately with the error message. Otherwise, preprocessing
      continues normally.</p>
      <h2 id="example-package-check">Example: Package Check</h2>
      <p>You can verify required packages are available before
      building:</p>
      <div class="sourceCode" id="cb3"><pre
      class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#preflight</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>required <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;dplyr&quot;</span>, <span class="st">&quot;ggplot2&quot;</span>, <span class="st">&quot;tidyr&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>missing <span class="ot">&lt;-</span> required[<span class="sc">!</span><span class="fu">sapply</span>(required, requireNamespace, <span class="at">quietly =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(missing) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;Missing required packages: &quot;</span>, <span class="fu">paste</span>(missing, <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">#endpreflight</span></span></code></pre></div>
      <h2 id="example-environment-check">Example: Environment Check</h2>
      <p>Validate environment variables or system requirements:</p>
      <div class="sourceCode" id="cb4"><pre
      class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#preflight</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>api_key <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;API_KEY&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nchar</span>(api_key) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;API_KEY environment variable must be set&quot;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(.Platform<span class="sc">$</span>OS.type <span class="sc">!=</span> <span class="st">&quot;unix&quot;</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">&quot;This package is optimized for Unix systems&quot;</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#endflight</span></span></code></pre></div>
      <h2 id="end-markers">End Markers</h2>
      <p>Two end markers are supported:</p>
      <ul>
      <li><code>#endpreflight</code> - The formal closing tag</li>
      <li><code>#endflight</code> - A convenient shorthand</li>
      </ul>
      <p>Both are functionally equivalent.</p>
      <h2 id="behavior-on-failure">Behavior on Failure</h2>
      <p>When preflight code fails:</p>
      <ul>
      <li>The error message is displayed</li>
      <li>Builder exits with a non-zero status code</li>
      <li>No output files are generated</li>
      </ul>
      <p>This makes preflight checks ideal for CI/CD pipelines where you
      want builds to fail fast if requirements aren’t met.</p>
      <h2 id="placement">Placement</h2>
      <p>Preflight blocks can appear anywhere in your source file, but
      are typically placed at the top before any other code. The block
      is processed when encountered during the sequential file
      reading.</p>
      <h2 id="limitations">Limitations</h2>
      <ul>
      <li>Preflight code is not preprocessed (no macros, no
      <code>#define</code> substitution)</li>
      <li>The code block must be valid R syntax on its own</li>
      <li>Output from preflight code is not captured in any output
      files</li>
      </ul>
    </main>
  </body>
</html>
